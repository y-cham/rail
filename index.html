<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>근무 스케줄 캘린더</title>
  <!-- Tailwind CSS CDN을 로드합니다. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Inter 폰트를 사용합니다. */
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="font-sans m-0 p-0 bg-gray-100 text-gray-800">

  <!-- 첫 번째 페이지: 조 선택 -->
  <div id="pattern-selection-page" class="container max-w-md mx-auto my-20 p-8 bg-white rounded-lg shadow-lg flex flex-col items-center justify-center">
    <h1 class="text-center text-3xl font-extrabold mb-8 text-gray-900">근무조 선택</h1>

    <div class="pattern-select flex flex-col gap-4 mb-8 p-6 bg-blue-50 rounded-lg shadow-inner w-full">
      <label class="flex items-center space-x-3 text-xl text-gray-700">
        <input type="radio" name="selectPattern" value="A" checked class="form-radio h-6 w-6 text-blue-600">
        <span>A조</span>
      </label>
      <label class="flex items-center space-x-3 text-xl text-gray-700">
        <input type="radio" name="selectPattern" value="B" class="form-radio h-6 w-6 text-blue-600">
        <span>B조</span>
      </label>
      <label class="flex items-center space-x-3 text-xl text-gray-700">
        <input type="radio" name="selectPattern" value="C" class="form-radio h-6 w-6 text-blue-600">
        <span>C조</span>
      </label>
      <label class="flex items-center space-x-3 text-xl text-gray-700">
        <input type="radio" name="selectPattern" value="D" class="form-radio h-6 w-6 text-blue-600">
        <span>D조</span>
      </label>
    </div>

    <button id="goToCalendarBtn" class="px-8 py-3 bg-green-500 text-white text-xl font-semibold rounded-lg shadow-md hover:bg-green-600 transition-colors duration-200">
      캘린더 보기
    </button>
  </div>

  <!-- 두 번째 페이지: 캘린더 -->
  <div id="calendar-page" class="container max-w-4xl mx-auto my-5 p-5 bg-white rounded-lg shadow-lg" style="display: none;">
    <h1 class="text-center text-3xl font-extrabold mb-6 text-gray-900">철도 근무 스케줄 캘린더 (<span id="selectedTeamDisplay">A조</span>)</h1>

    <!-- 로딩 메시지 및 사용자 ID 표시 -->
    <div id="loading-area" class="text-center mt-4 mb-2">
      <div id="loading-message" class="text-gray-600"></div>
      <div id="user-id-display" class="text-sm text-gray-500 mt-1"></div>
    </div>

    <!-- 현재 표시 월/년도 및 월 이동 버튼 -->
    <div class="flex justify-between items-center mb-4">
      <button id="prevMonthBtn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors duration-200">이전 달</button>
      <div id="currentMonthYear" class="text-center text-xl font-bold text-gray-800"></div>
      <button id="nextMonthBtn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors duration-200">다음 달</button>
    </div>

    <!-- 오늘 날짜를 표시하는 영역 -->
    <div id="today-date" class="text-center text-lg font-semibold mb-4 text-blue-600"></div>

    <!-- 요일 라벨 -->
    <div class="day-labels grid grid-cols-7 font-bold text-center mt-5 text-gray-700 text-base py-2 border-b border-gray-300">
      <div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div><div>일</div>
    </div>
    <!-- 캘린더 날짜가 표시될 영역 -->
    <div id="calendar" class="grid grid-cols-7 gap-1 mt-2"></div>

    <!-- 하단 버튼: 이전 페이지, 로그인/로그아웃 -->
    <div class="flex justify-between mt-8">
      <button id="backToSelectionBtn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">
        이전 페이지
      </button>
      <!-- 로그인 상태에 따라 버튼 텍스트 변경 -->
      <button id="authActionBtn" class="px-6 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200">
        로그인
      </button>
    </div>
  </div>

  <!-- 인증 모달 -->
  <div id="auth-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
      <h2 class="text-center text-2xl font-bold mb-6 text-gray-800">로그인 또는 회원가입</h2>
      <input type="email" id="modal-email" placeholder="이메일" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      <input type="password" id="modal-password" placeholder="비밀번호" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-500">
      <div id="modal-auth-message" class="text-center text-red-500 mb-4"></div>
      <button id="modal-signUpBtn" class="w-full px-4 py-3 mb-3 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 transition-colors duration-200">회원가입</button>
      <button id="modal-signInBtn" class="w-full px-4 py-3 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 transition-colors duration-200">로그인</button>
      <button id="close-modal-btn" class="w-full px-4 py-3 mt-4 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300 transition-colors duration-200">닫기</button>
    </div>
  </div>

  <script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // DOM 요소 참조
    const patternSelectionPage = document.getElementById('pattern-selection-page');
    const calendarPage = document.getElementById('calendar-page');
    const goToCalendarBtn = document.getElementById('goToCalendarBtn');
    const backToSelectionBtn = document.getElementById('backToSelectionBtn');
    const authActionBtn = document.getElementById('authActionBtn'); // 로그인/로그아웃 버튼
    const selectedTeamDisplay = document.getElementById('selectedTeamDisplay');
    const calendarEl = document.getElementById('calendar');
    const todayDateEl = document.getElementById('today-date');
    const currentMonthYearEl = document.getElementById('currentMonthYear');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const loadingMessageEl = document.getElementById('loading-message');
    const userIdDisplayEl = document.getElementById('user-id-display');

    // 인증 모달 관련 DOM 요소
    const authModal = document.getElementById('auth-modal');
    const modalEmailInput = document.getElementById('modal-email');
    const modalPasswordInput = document.getElementById('modal-password');
    const modalSignUpBtn = document.getElementById('modal-signUpBtn');
    const modalSignInBtn = document.getElementById('modal-signInBtn');
    const modalAuthMessageEl = document.getElementById('modal-auth-message');
    const closeModalBtn = document.getElementById('close-modal-btn');

    // 전역 변수
    let currentDisplayDate = new Date(); // 현재 캘린더에 표시될 년도와 월을 추적
    let selectedPatternKey = 'A'; // 선택된 조 (기본값 A)

    // Firebase 관련 전역 변수
    let db;
    let auth;
    let userId = null; // 초기 사용자 ID는 null
    let isFirebaseReady = false;
    let customShiftsForCurrentMonth = new Map(); // 현재 표시 월의 사용자 정의 근무를 저장

    // Canvas 환경에서 제공되는 전역 변수 (필수 사용)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

    // 각 근무 패턴 정의 (약어 적용)
    const shiftPatterns = {
      'A': ['주', '야', '비', '휴'], // 주간, 야간, 비번, 휴무
      'B': ['야', '비', '휴', '주'],
      'C': ['비', '휴', '주', '야'],
      'D': ['휴', '주', '야', '비']
    };

    // 7월 15일 (2025년)을 기준으로 각 조가 가져야 할 근무 형태 (약어 적용)
    const targetShiftForJuly15_2025 = {
      'A': '휴', // 휴무
      'B': '주', // 주간
      'C': '야', // 야간
      'D': '비'  // 비번
    };

    // Firebase 초기화 및 인증
    async function initializeFirebase() {
      try {
        if (!Object.keys(firebaseConfig).length) {
          console.error("Firebase config is missing or empty. Data persistence will not work.");
          loadingMessageEl.textContent = 'Firebase 설정 오류: 데이터 저장이 불가능합니다.';
          return;
        }

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // 인증 상태 변경 리스너
        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            isFirebaseReady = true;
            userIdDisplayEl.textContent = `사용자 ID: ${userId}`;
            loadingMessageEl.style.display = 'none'; // 로딩 메시지 숨김
            authActionBtn.textContent = '로그아웃'; // 로그인 상태일 때 로그아웃 버튼 표시
            
            // 캘린더 페이지가 활성화된 경우 데이터 로드 및 렌더링
            if (calendarPage.style.display === 'block') {
                loadAndRenderCalendar();
            }
          } else {
            userId = null;
            isFirebaseReady = false;
            userIdDisplayEl.textContent = '';
            loadingMessageEl.textContent = '로그인 필요 (저장 기능)';
            authActionBtn.textContent = '로그인'; // 로그아웃 상태일 때 로그인 버튼 표시
            // 캘린더 페이지가 활성화된 경우에도 로그인되지 않은 상태로 캘린더를 렌더링 (저장 기능 비활성화)
            if (calendarPage.style.display === 'block') {
                loadAndRenderCalendar(); // 저장된 데이터 없이 기본 패턴으로 렌더링
            }
          }
        });

      } catch (error) {
        console.error("Error initializing Firebase:", error);
        loadingMessageEl.textContent = `Firebase 초기화 오류: ${error.message}`;
      }
    }

    // 페이지 전환 함수
    function showPage(pageId) {
      patternSelectionPage.style.display = 'none';
      calendarPage.style.display = 'none';
      document.getElementById(pageId).style.display = 'block';
    }

    // 인증 모달 표시/숨김 함수
    function showAuthModal(message = '') {
      modalAuthMessageEl.textContent = message;
      authModal.style.display = 'flex';
      modalEmailInput.value = ''; // 모달 열릴 때 입력 필드 초기화
      modalPasswordInput.value = '';
    }

    function hideAuthModal() {
      authModal.style.display = 'none';
      modalAuthMessageEl.textContent = '';
    }

    // 회원가입 처리 (모달 내부)
    modalSignUpBtn.addEventListener('click', async () => {
      const email = modalEmailInput.value;
      const password = modalPasswordInput.value;
      if (!email || !password) {
        modalAuthMessageEl.textContent = '이메일과 비밀번호를 입력해주세요.';
        return;
      }
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        modalAuthMessageEl.textContent = '회원가입 성공! 자동으로 로그인됩니다.';
        hideAuthModal(); // 성공 시 모달 닫기
      } catch (error) {
        console.error("회원가입 오류:", error);
        modalAuthMessageEl.textContent = `회원가입 실패: ${error.message}`;
      }
    });

    // 로그인 처리 (모달 내부)
    modalSignInBtn.addEventListener('click', async () => {
      const email = modalEmailInput.value;
      const password = modalPasswordInput.value;
      if (!email || !password) {
        modalAuthMessageEl.textContent = '이메일과 비밀번호를 입력해주세요.';
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
        modalAuthMessageEl.textContent = '로그인 성공!';
        hideAuthModal(); // 성공 시 모달 닫기
      } catch (error) {
        console.error("로그인 오류:", error);
        modalAuthMessageEl.textContent = `로그인 실패: ${error.message}`;
      }
    });

    // 모달 닫기 버튼
    closeModalBtn.addEventListener('click', hideAuthModal);

    // 로그인/로그아웃 버튼 클릭 이벤트
    authActionBtn.addEventListener('click', async () => {
      if (userId) { // 로그인 상태일 때 -> 로그아웃
        try {
          await signOut(auth);
          alert("로그아웃 되었습니다.");
          // onAuthStateChanged 리스너가 로그아웃 상태를 감지하여 UI 업데이트
        } catch (error) {
          console.error("로그아웃 오류:", error);
          alert("로그아웃 중 오류가 발생했습니다.");
        }
      } else { // 로그아웃 상태일 때 -> 로그인 모달 표시
        showAuthModal();
      }
    });

    // 근무 형태를 Firestore에 저장하는 함수
    async function saveShift(year, month, day, shiftValue) {
      if (!isFirebaseReady || !userId) {
        console.warn("Firebase not ready or user not authenticated. Cannot save shift.");
        // 이 경고는 UI에서 이미 처리되므로 alert는 생략
        return;
      }
      const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
      const docRef = doc(db, 'artifacts', appId, 'users', userId, 'shifts', monthKey);
      try {
        await setDoc(docRef, { [String(day)]: shiftValue }, { merge: true });
        console.log(`Shift for ${monthKey}, day ${day} saved successfully.`);
      } catch (error) {
        console.error("Error saving shift:", error);
        alert("근무 정보 저장 중 오류가 발생했습니다.");
      }
    }

    // Firestore에서 근무 형태를 로드하는 함수 (onSnapshot 사용)
    let unsubscribeFromShifts = null; // 이전 월의 리스너를 해제하기 위한 변수

    function loadShiftsForMonth(year, month) {
      if (unsubscribeFromShifts) {
        unsubscribeFromShifts(); // 이전 월의 리스너 해제
      }

      if (!isFirebaseReady || !userId) {
        console.warn("Firebase not ready or user not authenticated. Loading default shifts.");
        customShiftsForCurrentMonth = new Map(); // 로그인 안 했으면 저장된 데이터 없음
        renderCalendarDays();
        return;
      }

      const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
      const docRef = doc(db, 'artifacts', appId, 'users', userId, 'shifts', monthKey);

      unsubscribeFromShifts = onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
          customShiftsForCurrentMonth = new Map(Object.entries(docSnap.data()));
          console.log("Custom shifts loaded:", customShiftsForCurrentMonth);
        } else {
          customShiftsForCurrentMonth = new Map(); // 해당 월에 저장된 데이터 없음
          console.log("No custom shifts found for this month.");
        }
        renderCalendarDays(); // 로드된 데이터를 적용하여 캘린더 날짜 다시 렌더링
      }, (error) => {
        console.error("Error loading shifts:", error);
        alert("근무 정보 로드 중 오류가 발생했습니다.");
        customShiftsForCurrentMonth = new Map(); // 오류 발생 시 초기화
        renderCalendarDays();
      });
    }

    // 캘린더의 날짜 부분만 렌더링하는 함수 (데이터 로드 후 호출)
    function renderCalendarDays() {
      const displayYear = currentDisplayDate.getFullYear();
      const displayMonth = currentDisplayDate.getMonth();

      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth();
      const currentDayOfMonth = today.getDate();

      const firstDayOfMonth = new Date(displayYear, displayMonth, 1);
      const lastDayOfMonth = new Date(displayYear, displayMonth + 1, 0);
      const daysInMonth = lastDayOfMonth.getDate();

      calendarEl.innerHTML = ''; // 기존 날짜 요소 모두 제거

      const currentShiftPattern = shiftPatterns[selectedPatternKey];
      const patternLength = currentShiftPattern.length;

      let startingShiftIndexForFirstDayOfMonth = 0;

      // 2025년 7월 (month 6)인 경우에만 7월 15일 기준 근무 형태를 적용합니다.
      if (displayYear === 2025 && displayMonth === 6) {
        const targetShift = targetShiftForJuly15_2025[selectedPatternKey];
        const targetShiftIndex = currentShiftPattern.indexOf(targetShift);
        if (targetShiftIndex !== -1) {
          const daysOffsetFromFirstToJuly15 = 14;
          startingShiftIndexForFirstDayOfMonth = (targetShiftIndex - (daysOffsetFromFirstToJuly15 % patternLength) + patternLength) % patternLength;
        }
      }

      let emptyStartDays = (firstDayOfMonth.getDay() + 6) % 7; // 월요일 시작 보정
      for (let i = 0; i < emptyStartDays; i++) {
        const blank = document.createElement('div');
        blank.className = 'day-placeholder bg-gray-50 rounded-md';
        calendarEl.appendChild(blank);
      }

      for (let i = 1; i <= daysInMonth; i++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'day bg-blue-50 p-2 rounded-md min-h-[80px] relative cursor-pointer hover:bg-blue-100 transition-colors duration-200';

        // 오늘 날짜를 강조합니다. (현재 시스템 날짜 기준)
        if (i === currentDayOfMonth && displayMonth === currentMonth && displayYear === currentYear) {
          dayEl.classList.add('border-2', 'border-blue-500', 'bg-blue-200', 'shadow-md');
        }

        const shiftIndexForCurrentDay = (startingShiftIndexForFirstDayOfMonth + (i - 1)) % patternLength;
        let shift = currentShiftPattern[shiftIndexForCurrentDay]; // 기본 패턴 근무

        // Firestore에서 로드된 사용자 정의 근무가 있다면 적용
        // 단, 로그인이 되어있고 데이터가 로드되었을 때만 적용
        if (userId && customShiftsForCurrentMonth.has(String(i))) {
          shift = customShiftsForCurrentMonth.get(String(i));
        }

        dayEl.innerHTML = `
          <span class="absolute top-1 right-2 text-sm text-gray-600 font-medium">${i}</span>
          <div class="shift mt-5 font-bold text-base text-center text-blue-800">${shift}</div>
        `;

        dayEl.addEventListener('click', () => {
          if (!userId) { // 로그인이 되어있지 않으면 모달 표시
            showAuthModal("근무를 저장하려면 로그인해주세요.");
            return; // 함수 실행 중단
          }

          // 로그인이 되어있으면 근무 수정 프롬프트 표시
          const validShifts = ['주', '야', '비', '휴', '지주', '지야', '초주', '초야'];
          const newShift = prompt(`근무 형태를 입력하세요 (${validShifts.join('/')}):`, shift);
          
          if (newShift !== null && validShifts.includes(newShift)) {
            dayEl.querySelector('.shift').textContent = newShift;
            saveShift(displayYear, displayMonth, i, newShift); // 변경된 근무 저장
          } else if (newShift !== null) {
            alert(`유효한 근무 형태를 입력해주세요: ${validShifts.join(', ')}`);
          }
        });

        calendarEl.appendChild(dayEl);
      }
    }

    // 캘린더 구조 (월/년도, 오늘 날짜, 조 표시)를 렌더링하는 함수
    function renderCalendarStructure() {
      const displayYear = currentDisplayDate.getFullYear();
      const displayMonth = currentDisplayDate.getMonth();

      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth();
      const currentDayOfMonth = today.getDate();

      currentMonthYearEl.textContent = `${displayYear}년 ${displayMonth + 1}월`;
      todayDateEl.textContent = `${currentYear}년 ${currentMonth + 1}월 ${currentDayOfMonth}일`;
      selectedTeamDisplay.textContent = `${selectedPatternKey}조`;
    }

    // 캘린더 전체를 로드하고 렌더링하는 메인 함수
    function loadAndRenderCalendar() {
      renderCalendarStructure(); // 정적 구조 렌더링
      loadShiftsForMonth(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth()); // 해당 월의 근무 로드 및 날짜 렌더링 트리거
    }

    // 월 이동 버튼 이벤트 리스너
    prevMonthBtn.addEventListener('click', () => {
      currentDisplayDate.setMonth(currentDisplayDate.getMonth() - 1);
      loadAndRenderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
      currentDisplayDate.setMonth(currentDisplayDate.getMonth() + 1);
      loadAndRenderCalendar();
    });

    // "캘린더 보기" 버튼 클릭 이벤트
    goToCalendarBtn.addEventListener('click', () => {
      const selectedRadio = document.querySelector('input[name="selectPattern"]:checked');
      if (selectedRadio) {
        selectedPatternKey = selectedRadio.value;
        currentDisplayDate = new Date(); // 캘린더 페이지로 이동 시 현재 월로 초기화
        showPage('calendar-page');
        // 캘린더를 로드하고 렌더링 (로그인 여부에 따라 데이터 로드 방식이 달라짐)
        loadAndRenderCalendar();
      } else {
        alert('조를 선택해주세요.');
      }
    });

    // "이전 페이지" 버튼 클릭 이벤트
    backToSelectionBtn.addEventListener('click', () => {
      showPage('pattern-selection-page'); // 조 선택 페이지로 돌아감
      if (unsubscribeFromShifts) {
        unsubscribeFromShifts(); // 캘린더 페이지를 떠날 때 Firestore 리스너 해제
      }
    });

    // 초기 페이지 로드 시 Firebase 초기화 및 조 선택 페이지 표시
    initializeFirebase();
    showPage('pattern-selection-page');
  </script>
</body>
</html>
